<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Temperatura</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Reset básico e configurações gerais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f4f7fa;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Estilo para a janela modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border: 2px solid #005f99;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #001f3f;
            font-weight: 600;
            text-align: center;
        }

        .modal-content select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            font-size: 14px;
            margin-bottom: 20px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .modal-content select:focus {
            border-color: #005f99;
            box-shadow: 0 0 8px rgba(0, 95, 153, 0.2);
            outline: none;
        }

        .modal-content button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #001f3f, #003087);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .modal-content button:hover {
            background: linear-gradient(135deg, #003087, #005f99);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* Estilo para o botão Trocar Unidade */
.change-unit-button {
    padding: 8px 16px; /* Reduzido para tornar o botão menor */
    background: linear-gradient(135deg, #005f99, #0077cc);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px; /* Tamanho da fonte reduzido */
    transition: all 0.3s ease;
    margin-top: 10px;
    display: inline-block; /* Garante que o botão não ocupe a largura total */
}

.change-unit-button:hover {
    background: linear-gradient(135deg, #003087, #005f99);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

        /* Estilo para o subtítulo da unidade */
        .unit-subtitle {
            font-size: 18px;
            color: #001f3f;
            margin-top: 5px;
            font-weight: 500;
        }

        /* Barra de título */
        .header {
            background-color: #ffffff;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1100;
        }

        .header-logo {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            height: 100px;
            width: auto;
            z-index: 1200;
            transition: transform 0.3s ease;
        }

        .header-logo:hover {
            transform: translateY(-50%) scale(1.05);
        }

        .header h1 {
            font-size: 28px;
            color: #001f3f;
            font-weight: 700;
            transition: transform 0.3s ease, color 0.3s ease;
        }

        .header h1:hover {
            transform: scale(1.05);
            color: #005f99;
        }

        .header h1::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 3px;
            background-color: #005f99;
            transition: width 0.3s ease;
        }

        .header h1:hover::after {
            width: 100%;
        }

        /* Barra de navegação */
        nav {
            background-color: #001f3f;
            padding: 15px 20px;
            display: flex;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 80px;
            z-index: 1000;
        }

        .tabs {
            display: flex;
            gap: 20px;
        }

        .tab-button {
            background: linear-gradient(135deg, #08325f, #1d4ca5);
            border: none;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .tab-button:hover {
            background: linear-gradient(135deg, #003087, #005f99);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #005f99, #0077cc);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 50%;
            height: 3px;
            background-color: #ffffff;
            border-radius: 2px;
        }

        /* Área de conteúdo */
        .content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
        }

        .content-frame {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 1200px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .content-frame:hover {
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            margin-bottom: 20px;
            color: #001f3f;
            font-weight: 600;
        }

        p {
            line-height: 1.6;
        }

        /* Estilos para formulários e cards */
        .form-group {
            display: flex;
            flex-wrap: nowrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #001f3f;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #f9f9f9;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: #005f99;
            box-shadow: 0 0 8px rgba(0, 95, 153, 0.2);
            outline: none;
        }

        .form-group input#data {
            max-width: 150px;
        }

        .form-group select#dados-mnemonico {
            max-width: 150px;
        }

        .form-group select#dados-responsavel {
            min-width: 150px;
            max-width: 250px;
        }

        .form-group input[type="number"] {
            max-width: 100px;
        }

        .form-group input.invalid, .form-group select.invalid {
            border-color: #ff4d4d;
            background-color: #ffecec;
        }

        .form-group button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #001f3f, #003087);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            align-self: flex-end;
            font-weight: 600;
        }

        .form-group button:hover {
            background: linear-gradient(135deg, #003087, #005f99);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .cadastro-sections {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .cadastro-section {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 100%;
        }

        .cadastro-section:last-child {
            max-width: 500px;
            margin: 0 auto;
        }

        .cadastro-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .toggle-button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #001f3f, #003087);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .toggle-button:hover {
            background: linear-gradient(135deg, #003087, #005f99);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .toggle-button.active {
            background: linear-gradient(135deg, #005f99, #0077cc);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .cadastro-section.hidden {
            display: none;
        }

        .cadastro-section .form-group {
            flex-direction: column;
        }

        .cadastro-section .input-group {
            display: flex;
            flex-wrap: nowrap;
            gap: 15px;
        }

        .cadastro-section .input-group input#mnemonico, .cadastro-section .input-group input#tipo {
            flex: 1;
            min-width: 75px;
            max-width: 150px;
        }

        .cadastro-section .input-group input#legenda {
            flex: 1;
            min-width: 150px;
            max-width: 300px;
        }

        .list-items {
            margin-top: 15px;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .list-item:hover {
            background-color: #f1f1f1;
        }

        .list-item button {
            background: linear-gradient(135deg, #ff4d4d, #cc0000);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .list-item button:hover {
            background: linear-gradient(135deg, #cc0000, #a30000);
            transform: translateY(-1px);
        }

        .mnemonico-cards {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .mnemonico-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .mnemonico-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .mnemonico-card .card-content {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            align-items: flex-end;
            overflow-x: auto;
        }

        .mnemonico-card .card-field {
            display: flex;
            flex-direction: column;
            min-width: 100px;
            flex-shrink: 0;
        }

        .mnemonico-card .card-field label {
            font-size: 12px;
            font-weight: 600;
            color: #001f3f;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mnemonico-card .card-field input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .mnemonico-card .card-field input:focus {
            border-color: #005f99;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 95, 153, 0.2);
        }

        .mnemonico-card .delete-card {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #ff4d4d, #cc0000);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 600;
        }

        .mnemonico-card .delete-card:hover {
            background: linear-gradient(135deg, #cc0000, #a30000);
            transform: translateY(-1px);
        }

        .dados-cards {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .dados-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: nowrap;
            gap: 15px;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .dados-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .dados-card .field {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .dados-card input, .dados-card select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 100%;
            background-color: #f9f9f9;
        }

        .dados-card input#data {
            max-width: 150px;
        }

        .dados-card input[readonly]:not([type="date"]) {
            max-width: 150px;
            background-color: #f0f0f0;
            color: #555;
        }

        .dados-card input[type="number"] {
            max-width: 100px;
        }

        .dados-card input.invalid {
            border-color: #ff4d4d;
            background-color: #ffecec;
        }

        .delete-card {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #ff4d4d;
            transition: color 0.2s;
        }

        .delete-card:hover {
            color: #ffffff;
        }

        /* Paginação */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 15px;
            background: linear-gradient(135deg, #001f3f, #003087);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .pagination button:hover {
            background: linear-gradient(135deg, #003087, #005f99);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .pagination button.active {
            background: linear-gradient(135deg, #005f99, #0077cc);
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .pagination button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Estilos para o Dashboard */
        .dashboard-filter {
            background: linear-gradient(135deg, #ffffff, #f9f9f9);
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: nowrap;
            gap: 20px;
            align-items: flex-end;
            transition: box-shadow 0.3s ease;
        }

        .dashboard-filter:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .dashboard-filter select {
            min-width: 120px;
            max-width: 150px;
            padding: 12px 35px 12px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="%23001f3f" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .dashboard-filter select:focus {
            border-color: #005f99;
            box-shadow: 0 0 12px rgba(0, 95, 153, 0.3), 0 4px 8px rgba(0,0,0,0.15);
            outline: none;
            transform: translateY(-1px);
        }

        .dashboard-filter select:hover {
            border-color: #005f99;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        .dashboard-filter .info-field {
            display: flex;
            flex-direction: column;
        }

        .dashboard-filter label {
            font-weight: 600;
            color: #001f3f;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dashboard-filter .info-field span {
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
            border-radius: 8px;
            min-width: 120px;
            max-width: 150px;
            color: #495057;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .dashboard-filter .info-field.legenda span {
            min-width: 200px;
            max-width: 300px;
            text-align: left;
        }

        .dashboard-filter .info-field span:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            border-color: #005f99;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .dashboard-filter button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #001f3f, #003087);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .dashboard-filter button:hover {
            background: linear-gradient(135deg, #003087, #005f99);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .dashboard-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .dashboard-table th, .dashboard-table td {
            border: 1px solid #ddd;
            padding: 12px 15px;
            text-align: left;
            font-size: 14px;
        }

        .dashboard-table th {
            background: linear-gradient(135deg, #001f3f, #003087);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dashboard-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .dashboard-table tr:hover {
            background-color: #e6f0fa;
            transform: scale(1.01);
            transition: background-color 0.2s, transform 0.2s;
        }

        .dashboard-table td {
            color: #333;
            transition: color 0.2s;
        }

        .dashboard-table td.out-of-range {
            background-color: #ffebee !important;
            color: #c62828 !important;
            font-weight: bold;
        }

        .dashboard-table td.at-limit {
            background-color: #fff8e1 !important;
            color: #f57c00 !important;
            font-weight: bold;
        }

        .dashboard-table td.out-of-range::after {
            content: "⚠️";
            margin-left: 8px;
            font-size: 16px;
        }

        .dashboard-table td.at-limit::after {
            content: "⚡";
            margin-left: 8px;
            font-size: 16px;
        }

        /* Estilos para os gráficos */
        .charts-container {
            display: flex;
            gap: 30px;
            margin-top: 40px;
            padding: 20px;
            background: linear-gradient(135deg, #ffffff, #f9f9f9);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-wrapper {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-title {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #001f3f;
            margin-bottom: 20px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }
        .loading {
        position: relative;
        cursor: not-allowed;
        opacity: 0.7;
    }

    .loading::after {
        content: '';
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #0099ff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
        margin-left: 8px;
        vertical-align: middle;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .list-item .edit-input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
        width: 100%;
        max-width: 200px;
    }

    .list-item .edit-input:focus {
        border-color: #005f99;
        outline: none;
        box-shadow: 0 0 5px rgba(0, 95, 153, 0.2);
    }

    .list-item .edit-input.invalid {
        border-color: #ff4d4d;
        background-color: #ffecec;
    }
    .pagination button.first-page {
        padding: 8px 15px;
        background: linear-gradient(135deg, #001f3f, #003087);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }

    .pagination button.first-page:hover {
        background: linear-gradient(135deg, #003087, #005f99);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .pagination button.first-page:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Estilo para o ícone de anotação */
.annotation-icon {
    position: absolute;
    bottom: 10px;
    right: 10px;
    font-size: 18px;
    color: #ccc;
    cursor: pointer;
    transition: color 0.3s ease;
}

.annotation-icon.has-note {
    color: #001f3f; /* Azul-marinho */
}

.annotation-icon:hover {
    color: #005f99;
}

/* Estilo para a janela modal de anotações */
.annotation-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    z-index: 2000;
    justify-content: center;
    align-items: center;
}

.annotation-modal-content {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 95, 153, 0.1); /* Sombra elegante */
    border: 2px solid #005f99;
    position: relative;
    animation: slideIn 0.3s ease;
}

.annotation-modal-content h3 {
    margin-bottom: 20px;
    color: #001f3f;
    font-weight: 600;
    text-align: center;
}

.annotation-modal-content textarea {
    width: 100%;
    height: 150px;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background-color: #f9f9f9;
    font-size: 14px;
    margin-bottom: 20px;
    resize: vertical;
    transition: border-color 0.3s, box-shadow 0.3s;
}

.annotation-modal-content textarea:focus {
    border-color: #005f99;
    box-shadow: 0 0 8px rgba(0, 95, 153, 0.2);
    outline: none;
}

.annotation-modal-content .modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.annotation-modal-content button {
    padding: 12px 24px;
    background: linear-gradient(135deg, #001f3f, #003087);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.annotation-modal-content button:hover {
    background: linear-gradient(135deg, #325d8f, #6a93af);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.annotation-modal-content .close-modal {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    font-size: 18px;
    color: #ff4d4d;
    cursor: pointer;
    transition: color 0.3s ease;
}

.annotation-modal-content .close-modal:hover {
    color: #ffffff;
}

/* Estilo para janela de visualização no dashboard */
.annotation-view-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    z-index: 2000;
    justify-content: center;
    align-items: center;
}

.annotation-view-modal-content {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 95, 153, 0.1); /* Sombra elegante */
    border: 2px solid #005f99;
    position: relative;
    animation: slideIn 0.3s ease;
}

.annotation-view-modal-content h3 {
    margin-bottom: 20px;
    color: #001f3f;
    font-weight: 600;
    text-align: center;
}

.annotation-view-modal-content .annotation-text {
    padding: 12px;
    background: #f9f9f9;
    border: 2px solid #ddd;
    border-radius: 8px;
    min-height: 100px;
    margin-bottom: 20px;
    font-size: 14px;
    color: #333;
    white-space: pre-wrap;
}

.annotation-view-modal-content .close-modal {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    font-size: 18px;
    color: #ff4d4d;
    cursor: pointer;
    transition: color 0.3s ease;
}

.annotation-view-modal-content .close-modal:hover {
    color: #cc0000;
}

.annotation-icon-table {
    float: right;
    margin-left: 10px;
    font-size: 16px;
    cursor: pointer;
    color: #001f3f;
    transition: color 0.3s ease;
}

.annotation-icon-table.has-note {
    color: #005f99;
}

.annotation-icon-table:hover {
    color: #0077cc;
}
/* Estilo para o alerta superior */
.alert {
    position: fixed;
    top: -100px; /* Começa escondido acima da tela */
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #ffffff, #f0f4f8);
    color: #001f3f;
    padding: 15px 30px;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    font-weight: 600;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3000;
    transition: top 0.5s ease-in-out;
    border: 1px solid #ddd;
    border-top: none;
}

.alert.visible {
    top: 0; /* Animação para deslizar para baixo */
}

.alert-success {
    position: fixed;
    top: -100px; /* Começa escondido acima da tela */
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #0a8610, #00b409);
    color: #ffffff;
    padding: 15px 30px;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    font-weight: 600;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3000;
    transition: top 0.5s ease-in-out;
    border: 1px solid #ddd;
    border-top: none;
}

.alert-success.visible {
    top: 0; /* Animação para deslizar para baixo */
}

.loader {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #005f99;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    margin-left: 15px;
}

.hidden {
    display: none;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.alert-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #ff4d4d;
    color: white;
    padding: 15px 20px;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}
/* Estilos para a tela de carregamento com fundo fosco */
.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 3000;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    transition: opacity 0.5s ease-in-out;
}

.loading-screen.hidden {
    opacity: 0;
    pointer-events: none;
}

.loading-spinner {
    border: 6px solid #f3f3f3;
    border-top: 6px solid #005f99;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

.loading-text {
    color: #ffffff;
    font-size: 18px;
    font-weight: 600;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    text-transform: uppercase;
    letter-spacing: 1px;
}
/* Estilo para a janela modal de senha */
.password-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    z-index: 2500;
    justify-content: center;
    align-items: center;
}

.password-modal-content {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    border: 2px solid #005f99;
    position: relative;
    animation: slideIn 0.3s ease;
}

.password-modal-content.shake {
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
    20%, 40%, 60%, 80% { transform: translateX(10px); }
}

.password-modal-content h3 {
    margin-bottom: 20px;
    color: #001f3f;
    font-weight: 600;
    text-align: center;
}

.password-modal-content input {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background-color: #f9f9f9;
    font-size: 14px;
    margin-bottom: 20px;
    transition: border-color 0.3s, box-shadow 0.3s;
}

.password-modal-content input:focus {
    border-color: #005f99;
    box-shadow: 0 0 8px rgba(0, 95, 153, 0.2);
    outline: none;
}

.password-modal-content input.invalid {
    border-color: #ff4d4d;
    background-color: #ffecec;
}

.password-modal-content button {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #001f3f, #003087);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.password-modal-content button:hover {
    background: linear-gradient(135deg, #003087, #005f99);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.password-modal-content button.invalid {
    background: linear-gradient(135deg, #ff4d4d, #cc0000);
}

.password-modal-content .close-modal {
    position: absolute;
    top: 10px;
    right: 10px; /* Reduzido de 15px para 10px para alinhar mais à direita */
    background: none;
    border: none;
    font-size: 14px; /* Mantido de acordo com o ajuste anterior */
    color: #ff4d4d;
    cursor: pointer;
    transition: color 0.3s ease;
    padding: 4px; /* Reduzido para diminuir a área clicável horizontal */
    line-height: 1; /* Evita expansão vertical desnecessária */
    width: 30px; /* Define uma largura fixa para o botão */
    height: 30px; /* Define uma altura fixa para o botão */
    display: flex;
    align-items: center;
    justify-content: center;
}

.password-modal-content .close-modal:hover {
    color: #ffffff;
}
/* Estilo para o botão de arquivar */
.archive-button {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 12px;
    font-weight: 600;
    margin-right: 5px;
    top: 45px;
    right: 10px;
    position: absolute;
}

.archive-button:hover {
    background: linear-gradient(135deg, #e67e22, #d35400);
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

/* Estilo para a seção de itens arquivados */
.archived-section {
    margin-top: 20px;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.archived-section h4 {
    color: #001f3f;
    font-weight: 600;
    margin-bottom: 15px;
}

.archived-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.archived-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
    background-color: #f9f9f9;
    border-radius: 6px;
    transition: background-color 0.2s;
}

.archived-item:hover {
    background-color: #e6f0fa;
}

.archived-item span {
    font-size: 14px;
    color: #333;
}

.unarchive-button {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 12px;
    font-weight: 600;
}

.unarchive-button:hover {
    background: linear-gradient(135deg, #27ae60, #219653);
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}
.list-item .archive-responsavel-button {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 12px;
    font-weight: 600;
    margin-right: 5px;
}

.list-item .archive-responsavel-button:hover {
    background: linear-gradient(135deg, #e67e22, #d35400);
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}
/* Estilo para o contêiner do botão Backup e Download */
.backup-container {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 15px;
}

/* Estilo para o select de anos */
.year-select {
  padding: 8px;
  font-size: 16px;
  border-radius: 4px;
  border: 1px solid #ccc;
  background-color: #fff;
  cursor: pointer;
}

/* Estilo para o botão Download */
.download-btn {
  padding: 8px 16px;
  font-size: 16px;
  border: none;
  border-radius: 4px;
  background-color: #08407c;
  color: white;
  cursor: pointer;
  opacity: 0.25;
  pointer-events: none;
}

.download-btn.enabled {
  opacity: 1;
  pointer-events: auto;
}

.download-btn:hover.enabled {
  background-color: #003064;
}
    </style>
</head>
<body>
    <div class="loading-screen" id="loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text">Carregando dados...</div>
</div>
    <header class="header">
    <img src="https://raw.githubusercontent.com/LaboratorioLamic/Dados/889745f5320300e54e3c1de1f8255a95f7e4b5bc/assents/logo.png" alt="Logo" class="header-logo">
    <h1>Controle de Temperatura</h1>
    <div class="unit-subtitle" id="selected-unit">Selecione uma Unidade</div>
    <button class="change-unit-button" onclick="openUnitModal()">Trocar Unidade</button>
    <div id="alert-message" class="alert hidden">
        Aguardando preenchimento correto
        <span class="loader"></span>
    </div>
    <div id="alert-message-success" class="alert-success hidden">
        Dados atualizados com sucesso ✔
        </div>
    <div class="password-modal" id="password-modal">
        <div class="password-modal-content">
            <h3>Inserir Senha</h3>
            <button class="close-modal" onclick="closePasswordModal()">&#10006;</button>
            <input type="password" id="password-input" placeholder="Digite a senha">
            <button onclick="checkPassword()">Confirmar</button>
        </div>
    </div>
</header>

<nav>
    <div class="tabs">
        <button class="tab-button active" data-tab="dashboard">Dashboard</button>
        <button class="tab-button" data-tab="cadastro">Cadastro</button>
        <button class="tab-button" data-tab="dados">Dados</button>
    </div>
</nav>

    <div class="modal" id="unit-modal">
        <div class="modal-content">
            <h3>Selecionar Unidade</h3>
            <select id="unit-select">
                <option value="">Selecione uma Unidade</option>
                <option value="Caixas de Transporte">📦 Caixas de Transporte</option>
                <option value="01 - Unidade NTO">01 - Unidade NTO</option>
                <option value="03 - Unidade Crato">03 - Unidade Crato</option>
                <option value="05 - Unidade Novo Juazeiro">05 - Unidade Novo Juazeiro</option>
                <option value="06 - Unidade Milagres">06 - Unidade Milagres</option>
                <option value="09 - Unidade Barro">09 - Unidade Barro</option>
                <option value="10 - Unidade Office Cariri">10 - Unidade Office Cariri</option>
                <option value="12 - Unidade Caririaçu">12 - Unidade Caririaçu</option>
                <option value="13 - Unidade Campos Sales">13 - Unidade Campos Sales</option>
                <option value="16 - Unidade Araripe">16 - Unidade Araripe</option>
                <option value="23 - Unidade Salesianos">23 - Unidade Salesianos</option>
                <option value="88 - Unidade Unicardio">88 - Unidade Unicardio</option>
            </select>
            <button onclick="selectUnit()">Confirmar</button>
        </div>
    </div>

    <div class="annotation-modal" id="annotation-modal">
        <div class="annotation-modal-content">
            <h3>Anotações</h3>
            <button class="close-modal" onclick="closeAnnotationModal()">&#10006;</button>
            <textarea id="annotation-text" placeholder="Escreva suas anotações aqui..."></textarea>
            <div class="modal-buttons">
                <button onclick="saveAnnotation()">Adicionar</button>
                <button onclick="deleteAnnotation()">Apagar</button>
            </div>
        </div>
    </div>
    <div class="annotation-view-modal" id="annotation-view-modal">
        <div class="annotation-view-modal-content">
            <h3>Visualizar Anotações</h3>
            <button class="close-modal" onclick="closeAnnotationViewModal()">&#10006;</button>
            <div class="annotation-text" id="annotation-view-text"></div>
        </div>
    </div>

    <div class="content">
        <div class="content-frame">
            <div id="dashboard" class="tab-content active">
                <h2>Dashboard - Dados de Temperatura</h2>
                <div class="dashboard-filter">
                    <div>
                        <label>Mês</label>
                        <select id="filter-mes">
                            <option value="">Selecione</option>
                            <option value="1">Janeiro</option>
                            <option value="2">Fevereiro</option>
                            <option value="3">Março</option>
                            <option value="4">Abril</option>
                            <option value="5">Maio</option>
                            <option value="6">Junho</option>
                            <option value="7">Julho</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                    </div>
                    <div>
                        <label>Ano</label>
                        <select id="filter-ano"></select>
                    </div>
                    <div>
                        <label>Mnemonico</label>
                        <select id="filter-mnemonico">
                            <option value="">Selecione</option>
                        </select>
                    </div>
                    <div class="info-field">
                        <label>Tipo</label>
                        <span id="mnemonico-tipo"></span>
                    </div>
                    <div class="info-field legenda">
                        <label>Legenda</label>
                        <span id="mnemonico-legenda"></span>
                    </div>
                    <div class="info-field">
                        <label>Min</label>
                        <span id="mnemonico-min"></span>
                    </div>
                    <div class="info-field">
                        <label>Max</label>
                        <span id="mnemonico-max"></span>
                    </div>
                </div>
                <table class="dashboard-table" id="dashboard-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Mnemonico</th>
                            <th>Responsável</th>
                            <th>⛅ Min ºC</th>
                            <th>⛅ Max ºC</th>
                            <th>⛅ Atual ºC</th>
                            <th>🌞 Min ºC</th>
                            <th>🌞 Max ºC</th>
                            <th>🌞 Atual ºC</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <div class="chart-title">⛅ Temperaturas da Manhã</div>
                        <div class="chart-container">
                            <canvas id="manhaChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="chart-title">🌞 Temperaturas da Tarde</div>
                        <div class="chart-container">
                            <canvas id="tardeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div id="cadastro" class="tab-content">
                <h2>Cadastro de informações</h2>
                <div class="cadastro-buttons">
                    <button class="toggle-button" onclick="toggleCadastroSection('mnemonicos')">
                        <span id="mnemonicos-toggle-text">Mnemonicos</span>
                    </button>
                    <button class="toggle-button" onclick="toggleCadastroSection('responsaveis')">
                        <span id="responsaveis-toggle-text">Responsáveis</span>
                    </button>
                    <button id="downloadBtn" class="download-btn">Download Backup</button>
                    <select id="yearSelect" class="year-select">
                        <option value="">Ano</option>
                      </select>
                      <select id="formatSelect" class="year-select">
                        <option value="">Tipo</option>
                    </select>
                      
                </div>
                <div class="cadastro-sections">
                    <div class="cadastro-section" id="mnemonicos-section">
                        <h3>Mnemonicos</h3>
                        <div class="form-group">
                            <div class="input-group">
                                <div>
                                    <label for="mnemonico">Mnemonico</label>
                                    <input type="text" id="mnemonico">
                                </div>
                                <div>
                                    <label for="tipo">Tipo</label>
                                    <input type="text" id="tipo">
                                </div>
                                <div>
                                    <label for="legenda">Legenda</label>
                                    <input type="text" id="legenda">
                                </div>
                                <div>
                                    <label for="min">Min</label>
                                    <input type="number" id="min" step="0.1">
                                </div>
                                <div>
                                    <label for="max">Max</label>
                                    <input type="number" id="max" step="0.1">
                                </div>
                            </div>
                            <button onclick="addMnemonico()">Adicionar</button>
                        </div>
                        <div class="mnemonico-cards" id="mnemonicos-list"></div>
                    </div>
                    <div class="cadastro-section" id="responsaveis-section">
                        <h3>Cadastro de Responsáveis</h3>
                        <div class="form-group">
                            <div>
                                <label for="responsavel">Responsável</label>
                                <input type="text" id="responsavel">
                            </div>
                            <button onclick="addResponsavel()">Adicionar</button>
                        </div>
                        <div class="list-items" id="responsaveis-list"></div>
                    </div>
                </div>
            </div>
            <div id="dados" class="tab-content">
                <h2>Dados de Temperatura</h2>
                <div class="form-group">
                    <div>
                        <label>Data</label>
                        <input type="date" id="data">
                    </div>
                    <div>
                        <label>Mnemonico</label>
                        <select id="dados-mnemonico">
                            <option value="">Selecione</option>
                        </select>
                    </div>
                    <div>
                        <label>Responsável</label>
                        <select id="dados-responsavel">
                            <option value="">Selecione</option>
                        </select>
                    </div>
                    <div>
                        <label>⛅ Min ºC</label>
                        <input type="number" id="manha-min" step="0.1">
                    </div>
                    <div>
                        <label>⛅ Max ºC</label>
                        <input type="number" id="manha-max" step="0.1">
                    </div>
                    <div>
                        <label>⛅ Atual ºC</label>
                        <input type="number" id="manha-atual" step="0.1">
                    </div>
                    <div>
                        <label>🌞 Min ºC</label>
                        <input type="number" id="tarde-min" step="0.1">
                    </div>
                    <div>
                        <label>🌞 Max ºC</label>
                        <input type="number" id="tarde-max" step="0.1">
                    </div>
                    <div>
                        <label>🌞 Atual ºC</label>
                        <input type="number" id="tarde-atual" step="0.1">
                    </div>
                    <button onclick="addDado()">Adicionar</button>
                </div>
                <div class="dados-cards" id="dados-cards"></div>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuração do JSONBin.io
        const JSONBIN_API_KEY = '$2a$10$2elKW8TT6o.K3V176efqwu7kOfD1PnS3D/F0s4Tczc3MYmaU.N1bi';
        const JSONBIN_BASE_URL = 'https://api.jsonbin.io/v3/b';
        const JSONBIN_IDS = {
            1: '68dad995d0ea881f408f80d4',
            2: '68dad9d943b1c97be9548e19',
            3: '68dada3a43b1c97be9548e78',
            5: '68dada97ae596e708f0047cf',
            6: '68dadaaeae596e708f0047e2',
            9: '68dadab9d0ea881f408f8202',
            10: '68dadad443b1c97be9548f16',
            12: '68dadb09ae596e708f004838',
            13: '68dadb1a43b1c97be9548f45',
            14: '68dadb2ad0ea881f408f825c',
            16: '68dadb4143b1c97be9548f61',
            23: '68dadb5143b1c97be9548f6f',
            62: '68dadb6043b1c97be9548f79',
            88: '68dadb6dd0ea881f408f828e',
            97: '68dadb7cae596e708f0048a6'
        };
        
        // Dados em memória
        let mnemonicos = [];
        let archivedMnemonicos = [];
        let responsaveis = [];
        let archivedResponsaveis = [];
        let dados = [];
        let unidades = [
            { id: 2, name: "Caixas de Transporte" },
            { id: 1, name: "01 - Unidade NTO" },
            { id: 3, name: "03 - Unidade Crato" },
            { id: 5, name: "05 - Unidade Novo Juazeiro" },
            { id: 6, name: "06 - Unidade Milagres" },
            { id: 9, name: "09 - Unidade Barro" },
            { id: 10, name: "10 - Unidade Office Cariri" },
            { id: 12, name: "12 - Unidade Caririaçu" },
            { id: 13, name: "13 - Unidade Campos Sales" },
            { id: 14, name: "14 - Unidade Nova Olinda" },
            { id: 16, name: "16 - Unidade Araripe" },
            { id: 23, name: "23 - Unidade Salesianos" },
            { id: 62, name: "62 - Unidade Clemir Arrais" },
            { id: 88, name: "88 - Unidade Unicardio" },
            { id: 97, name: "97 - Unidade Endoclinic" }
        ];
        let currentPage = 1;
        const itemsPerPage = 40;
        const maxPagesDisplayed = 5;
        let selectedUnitId = null;
        
        // Variáveis para os gráficos
        let manhaChart = null;
        let tardeChart = null;
        
        // Temporizador para redirecionamento automático da aba Dados para Dashboard
        let dadosTabTimeout = null;
        
        // Função para iniciar o temporizador de redirecionamento
        function startDadosTabTimer() {
            clearDadosTabTimer();
            dadosTabTimeout = setTimeout(() => {
                redirectToDashboard();
            }, 60000);
        }
        
        // Função para limpar o temporizador
        function clearDadosTabTimer() {
            if (dadosTabTimeout) {
                clearTimeout(dadosTabTimeout);
                dadosTabTimeout = null;
            }
        }
        
        // Função para redirecionar para a aba Dashboard
        function redirectToDashboard() {
            document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tab-button[data-tab="dashboard"]').classList.add('active');
            document.getElementById('dashboard').classList.add('active');
            renderDashboardFilters();
            loadDashboardFilters();
            renderDashboardTable();
            updateCharts();
        }
        
        // Função para determinar o binID com base na unidade
        function getBinIdForUnit(unitId) {
            return JSONBIN_IDS[unitId];
        }
        
        // Funções para comunicação com JSONBin.io
        async function saveToJsonBin() {
            if (!selectedUnitId) return;
            const binId = getBinIdForUnit(selectedUnitId);
            const data = { mnemonicos, archivedMnemonicos, responsaveis, archivedResponsaveis, dados };
            try {
                const response = await fetch(`${JSONBIN_BASE_URL}/${binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    throw new Error('Erro ao salvar no JSONBin');
                }
            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('Erro ao salvar os dados no servidor.');
            }
        }
        
        async function loadFromJsonBin() {
            if (!selectedUnitId) return;
            const binId = getBinIdForUnit(selectedUnitId);
            toggleLoadingScreen(true);
            try {
                const response = await fetch(`${JSONBIN_BASE_URL}/${binId}/latest`, {
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });
                if (response.ok) {
                    const result = await response.json();
                    mnemonicos = result.record.mnemonicos || [];
                    archivedMnemonicos = result.record.archivedMnemonicos || [];
                    responsaveis = result.record.responsaveis || [];
                    archivedResponsaveis = result.record.archivedResponsaveis || [];
                    dados = result.record.dados || [];
                    renderMnemonicos();
                    renderResponsaveis();
                    renderDropdowns();
                    renderDadosCards();
                    renderPagination();
                    renderDashboardTable();
                    updateCharts();
                } else {
                    throw new Error('Erro ao carregar do JSONBin');
                }
            } catch (error) {
                console.error('Erro ao carregar:', error);
                alert('Erro ao carregar os dados do servidor.');
            } finally {
                toggleLoadingScreen(false);
            }
        }
        
        // Função para abrir a janela modal
        function openUnitModal() {
            const modal = document.getElementById('unit-modal');
            modal.style.display = 'flex';
            const select = document.getElementById('unit-select');
            select.value = '';
        }
        
        // Função para selecionar a unidade
        async function selectUnit() {
            const select = document.getElementById('unit-select');
            const selectedUnit = unidades.find(u => u.name === select.value);
            selectedUnitId = selectedUnit ? selectedUnit.id : null;
            localStorage.setItem('selectedUnitId', selectedUnitId);
            updateUnitDisplay();
            document.getElementById('unit-modal').style.display = 'none';
            if (selectedUnitId) {
                await loadFromJsonBin();
                document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('.tab-button[data-tab="dashboard"]').classList.add('active');
                document.getElementById('dashboard').classList.add('active');
                renderDashboardFilters();
                loadDashboardFilters();
                renderDashboardTable();
                createCharts();
            }
        }
        
        // Função para atualizar a exibição da unidade selecionada
        function updateUnitDisplay() {
            const unitDisplay = document.getElementById('selected-unit');
            const selectedUnit = unidades.find(u => u.id === selectedUnitId);
            unitDisplay.textContent = selectedUnit ? selectedUnit.name : 'Selecione uma Unidade';
        }
        
        // Funções para Cadastro de Mnemonicos
        async function addMnemonico() {
            if (!selectedUnitId) {
                alert('Por favor, selecione uma unidade antes de adicionar um mnemonico.');
                return;
            }
            const button = document.querySelector('#mnemonicos-section button');
            button.classList.add('loading');
            button.disabled = true;
            button.textContent = 'Adicionando';
        
            try {
                const mnemonico = document.getElementById('mnemonico').value.trim();
                const tipo = document.getElementById('tipo').value.trim();
                const legenda = document.getElementById('legenda').value.trim();
                const min = parseFloat(document.getElementById('min').value);
                const max = parseFloat(document.getElementById('max').value);
                if (mnemonico && tipo && legenda && !isNaN(min) && !isNaN(max)) {
                    const newId = mnemonicos.length > 0 ? Math.max(...mnemonicos.map(m => m.id || 0)) + 1 : 1;
                    mnemonicos.push({ id: newId, mnemonico, tipo, legenda, min, max });
                    await saveToJsonBin();
                    renderMnemonicos();
                    renderDropdowns();
                    document.getElementById('mnemonico').value = '';
                    document.getElementById('tipo').value = '';
                    document.getElementById('legenda').value = '';
                    document.getElementById('min').value = '';
                    document.getElementById('max').value = '';
                } else {
                    alert('Por favor, preencha todos os campos do mnemonico.');
                }
            } catch (error) {
                console.error('Erro ao adicionar mnemonico:', error);
                alert('Erro ao salvar os dados no servidor.');
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
                button.textContent = 'Adicionar';
            }
        }
        
        async function updateMnemonico(index, field, value) {
            if (field === 'min' || field === 'max') {
                if (isNaN(value)) return;
            }
            mnemonicos[index][field] = value;
            await saveToJsonBin();
            renderDropdowns();
            renderDashboardTable();
        }
        
        async function deleteMnemonico(index) {
    const mnemonicoId = mnemonicos[index].id;
    const isUsed = dados.some(d => d.mnemonicoId === mnemonicoId);
    if (isUsed) {
        alert("Não é possivel excluir, pois há dados emitidos");
        return;
    }
    if (!confirm('Tem certeza que deseja excluir este mnemonico?')) {
        return;
    }
    mnemonicos.splice(index, 1);
    await saveToJsonBin();
    renderMnemonicos();
    renderDropdowns();
    renderDashboardTable();
}

        async function archiveMnemonico(index) {
            const button = document.querySelectorAll('.mnemonico-card .archive-button')[index];
            if (button) {
                button.classList.add('loading');
                button.disabled = true;
                button.innerHTML = '<span class="spinner"></span>';
            }
        
            try {
                const mnemonico = mnemonicos.splice(index, 1)[0];
                archivedMnemonicos.push(mnemonico);
                await saveToJsonBin();
                renderMnemonicos();
                renderDropdowns();
                renderDashboardTable();
            } catch (error) {
                console.error('Erro ao arquivar mnemonico:', error);
                alert('Erro ao arquivar o mnemonico no servidor.');
            } finally {
                if (button) {
                    button.classList.remove('loading');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-archive"></i>';
                }
            }
        }
        
        async function unarchiveMnemonico(index) {
            const button = document.querySelectorAll('.archived-mnemonicos .unarchive-button')[index];
            if (button) {
                button.classList.add('loading');
                button.disabled = true;
                button.innerHTML = '<span class="spinner"></span>';
            }
        
            try {
                const mnemonico = archivedMnemonicos.splice(index, 1)[0];
                mnemonicos.push(mnemonico);
                await saveToJsonBin();
                renderMnemonicos();
                renderDropdowns();
                renderDashboardTable();
            } catch (error) {
                console.error('Erro ao desarquivar mnemonico:', error);
                alert('Erro ao desarquivar o mnemonico no servidor.');
            } finally {
                if (button) {
                    button.classList.remove('loading');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-undo"></i>';
                }
            }
        }
        
        function renderMnemonicos() {
            const list = document.getElementById('mnemonicos-list');
            list.innerHTML = '';
            const filteredMnemonicos = mnemonicos.sort((a, b) => a.mnemonico.localeCompare(b.mnemonico));
            filteredMnemonicos.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'mnemonico-card';
                card.innerHTML = `
                    <div class="card-content">
                        <div class="card-field">
                            <label>Mnemonico</label>
                            <input type="text" value="${item.mnemonico}" onchange="updateMnemonico(${index}, 'mnemonico', this.value)">
                        </div>
                        <div class="card-field">
                            <label>Tipo</label>
                            <input type="text" value="${item.tipo}" onchange="updateMnemonico(${index}, 'tipo', this.value)">
                        </div>
                        <div class="card-field">
                            <label>Legenda</label>
                            <input type="text" value="${item.legenda}" onchange="updateMnemonico(${index}, 'legenda', this.value)">
                        </div>
                        <div class="card-field">
                            <label>Min</label>
                            <input type="number" step="0.1" value="${item.min}" onchange="updateMnemonico(${index}, 'min', parseFloat(this.value))">
                        </div>
                        <div class="card-field">
                            <label>Max</label>
                            <input type="number" step="0.1" value="${item.max}" onchange="updateMnemonico(${index}, 'max', parseFloat(this.value))">
                        </div>
                    </div>
                    <button class="delete-card" onclick="deleteMnemonico(${index})">Excluir</button>
                    <button class="archive-button" onclick="archiveMnemonico(${index})"><i class="fas fa-archive"></i></button>
                `;
                list.appendChild(card);
            });
        
            // Renderizar mnemonicos arquivados
            const archivedList = document.createElement('div');
            archivedList.className = 'archived-section';
            archivedList.innerHTML = '<h4>Mnemonicos Arquivados</h4><div class="archived-list" id="archived-mnemonicos"></div>';
            list.appendChild(archivedList);
            const archivedMnemonicosList = document.getElementById('archived-mnemonicos');
            archivedMnemonicosList.innerHTML = '';
            const filteredArchivedMnemonicos = archivedMnemonicos.sort((a, b) => a.mnemonico.localeCompare(b.mnemonico));
            filteredArchivedMnemonicos.forEach((item, index) => {
                const archivedItem = document.createElement('div');
                archivedItem.className = 'archived-item';
                archivedItem.innerHTML = `
                    <span>${item.mnemonico} (${item.tipo})</span>
                    <button class="unarchive-button" onclick="unarchiveMnemonico(${index})"><i class="fas fa-undo"></i></button>
                `;
                archivedMnemonicosList.appendChild(archivedItem);
            });
        }
        
        // Funções para Cadastro de Responsáveis
        async function addResponsavel() {
            if (!selectedUnitId) {
                alert('Por favor, selecione uma unidade antes de adicionar um responsável.');
                return;
            }
            const button = document.querySelector('#responsaveis-section button');
            button.classList.add('loading');
            button.disabled = true;
            button.textContent = 'Adicionando';
        
            try {
                const responsavel = document.getElementById('responsavel').value.trim();
                if (responsavel) {
                    const newId = responsaveis.length > 0 ? Math.max(...responsaveis.map(r => r.id || 0)) + 1 : 1;
                    responsaveis.push({ id: newId, name: responsavel });
                    await saveToJsonBin();
                    renderResponsaveis();
                    renderDropdowns();
                    document.getElementById('responsavel').value = '';
                } else {
                    alert('Por favor, preencha o campo de responsável.');
                }
            } catch (error) {
                console.error('Erro ao adicionar responsável:', error);
                alert('Erro ao salvar os dados no servidor.');
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
                button.textContent = 'Adicionar';
            }
        }
        
        async function updateResponsavel(index, value) {
            const trimmedValue = value.trim();
            if (trimmedValue === '') {
                document.querySelectorAll('.list-item .edit-input')[index].classList.add('invalid');
                return;
            }
            responsaveis[index].name = trimmedValue;
            await saveToJsonBin();
            renderResponsaveis();
            renderDropdowns();
            renderDashboardTable();
        }
        
        async function deleteResponsavel(index) {
    const responsavelId = responsaveis[index].id;
    const isUsed = dados.some(d => d.responsavelId === responsavelId);
    if (isUsed) {
        alert("Não é possivel excluir, pois há dados emitidos");
        return;
    }
    if (!confirm('Tem certeza que deseja excluir este responsável?')) {
        return;
    }
    responsaveis.splice(index, 1);
    await saveToJsonBin();
    renderResponsaveis();
    renderDropdowns();
}

        async function archiveResponsavel(index) {
            const button = document.querySelectorAll('.list-item .archive-responsavel-button')[index];
            if (button) {
                button.classList.add('loading');
                button.disabled = true;
                button.innerHTML = '<span class="spinner"></span>';
            }
        
            try {
                const responsavel = responsaveis.splice(index, 1)[0];
                archivedResponsaveis.push(responsavel);
                await saveToJsonBin();
                renderResponsaveis();
                renderDropdowns();
                renderDashboardTable();
            } catch (error) {
                console.error('Erro ao arquivar responsável:', error);
                alert('Erro ao arquivar o responsável no servidor.');
            } finally {
                if (button) {
                    button.classList.remove('loading');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-archive"></i>';
                }
            }
        }
        
        async function unarchiveResponsavel(index) {
            const button = document.querySelectorAll('.archived-responsaveis .unarchive-button')[index];
            if (button) {
                button.classList.add('loading');
                button.disabled = true;
                button.innerHTML = '<span class="spinner"></span>';
            }
        
            try {
                const responsavel = archivedResponsaveis.splice(index, 1)[0];
                responsaveis.push(responsavel);
                await saveToJsonBin();
                renderResponsaveis();
                renderDropdowns();
                renderDashboardTable();
            } catch (error) {
                console.error('Erro ao desarquivar responsável:', error);
                alert('Erro ao desarquivar o responsável no servidor.');
            } finally {
                if (button) {
                    button.classList.remove('loading');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-undo"></i>';
                }
            }
        }
        
        function renderResponsaveis() {
            const list = document.getElementById('responsaveis-list');
            list.innerHTML = '';
            const filteredResponsaveis = responsaveis.sort((a, b) => a.name.localeCompare(b.name));
            filteredResponsaveis.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <input type="text" class="edit-input" value="${item.name}" onchange="updateResponsavel(${index}, this.value)">
                    <button class="archive-responsavel-button" onclick="archiveResponsavel(${index})"><i class="fas fa-archive"></i></button>
                    <button onclick="deleteResponsavel(${index})">Excluir</button>
                `;
                list.appendChild(div);
            });
        
            // Renderizar responsáveis arquivados
            const archivedList = document.createElement('div');
            archivedList.className = 'archived-section';
            archivedList.innerHTML = '<h4>Responsáveis Arquivados</h4><div class="archived-list" id="archived-responsaveis"></div>';
            list.appendChild(archivedList);
            const archivedResponsaveisList = document.getElementById('archived-responsaveis');
            archivedResponsaveisList.innerHTML = '';
            const filteredArchivedResponsaveis = archivedResponsaveis.sort((a, b) => a.name.localeCompare(b.name));
            filteredArchivedResponsaveis.forEach((item, index) => {
                const archivedItem = document.createElement('div');
                archivedItem.className = 'archived-item';
                archivedItem.innerHTML = `
                    <span>${item.name}</span>
                    <button class="unarchive-button" onclick="unarchiveResponsavel(${index})"><i class="fas fa-undo"></i></button>
                `;
                archivedResponsaveisList.appendChild(archivedItem);
            });
        }
        
        // Funções para Dropdowns
        function renderDropdowns() {
            const mnemonicoSelect = document.getElementById('dados-mnemonico');
            mnemonicoSelect.innerHTML = '<option value="">Selecione</option>';
            const filterMnemonicoSelect = document.getElementById('filter-mnemonico');
            filterMnemonicoSelect.innerHTML = '<option value="">Selecione</option>';
            const filteredMnemonicos = mnemonicos.sort((a, b) => a.mnemonico.localeCompare(b.mnemonico));
            filteredMnemonicos.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.mnemonico;
                mnemonicoSelect.appendChild(option.cloneNode(true));
                filterMnemonicoSelect.appendChild(option);
            });
        
            const responsavelSelect = document.getElementById('dados-responsavel');
            responsavelSelect.innerHTML = '<option value="">Selecione</option>';
            const filteredResponsaveis = responsaveis.sort((a, b) => a.name.localeCompare(b.name));
            filteredResponsaveis.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                responsavelSelect.appendChild(option);
            });
        }
        
        // Função de validação para o formulário de dados
        function validateDado(manhaMin, manhaMax, manhaAtual, tardeMin, tardeMax, tardeAtual) {
            let valid = true;
            const invalidFields = [];
        
            const inputs = ['manha-min', 'manha-max', 'manha-atual', 'tarde-min', 'tarde-max', 'tarde-atual', 'dados-mnemonico', 'dados-responsavel'];
            inputs.forEach(id => {
                document.getElementById(id).classList.remove('invalid');
            });
        
            if (!document.getElementById('dados-mnemonico').value) {
                invalidFields.push('dados-mnemonico');
                valid = false;
            }
            if (!document.getElementById('dados-responsavel').value) {
                invalidFields.push('dados-responsavel');
                valid = false;
            }
        
            if (manhaMin !== null && manhaMax !== null && manhaAtual !== null) {
                if (manhaMin > manhaAtual || manhaMin > manhaMax) {
                    invalidFields.push('manha-min');
                    valid = false;
                }
                if (manhaMax < manhaAtual || manhaMax < manhaMin) {
                    invalidFields.push('manha-max');
                    valid = false;
                }
                if (manhaAtual < manhaMin || manhaAtual > manhaMax) {
                    invalidFields.push('manha-atual');
                    valid = false;
                }
            } else if (manhaMin !== null && manhaAtual === null) {
                invalidFields.push('manha-min');
                valid = false;
            } else if (manhaMax !== null && manhaAtual === null) {
                invalidFields.push('manha-max');
                valid = false;
            }
        
            if (tardeMin !== null && tardeMax !== null && tardeAtual !== null) {
                if (tardeMin > tardeAtual || tardeMin > tardeMax) {
                    invalidFields.push('tarde-min');
                    valid = false;
                }
                if (tardeMax < tardeAtual || tardeMax < tardeMin) {
                    invalidFields.push('tarde-max');
                    valid = false;
                }
                if (tardeAtual < tardeMin || tardeAtual > tardeMax) {
                    invalidFields.push('tarde-atual');
                    valid = false;
                }
            } else if (tardeMin !== null && tardeAtual === null) {
                invalidFields.push('tarde-min');
                valid = false;
            } else if (tardeMax !== null && tardeAtual === null) {
                invalidFields.push('tarde-max');
                valid = false;
            }
        
            invalidFields.forEach(field => {
                document.getElementById(field).classList.add('invalid');
            });
        
            return valid;
        }
        
        // Funções para Dados
        async function addDado() {
            if (!selectedUnitId) {
                alert('Por favor, selecione uma unidade antes de adicionar dados.');
                return;
            }
            const button = document.querySelector('#dados button');
            button.classList.add('loading');
            button.disabled = true;
            button.textContent = '';
            try {
                const data = document.getElementById('data').value;
                const mnemonicoId = parseInt(document.getElementById('dados-mnemonico').value);
                const responsavelId = parseInt(document.getElementById('dados-responsavel').value);
        
                const manhaMin = document.getElementById('manha-min').value.trim() === '' ? null : parseFloat(document.getElementById('manha-min').value);
                const manhaMax = document.getElementById('manha-max').value.trim() === '' ? null : parseFloat(document.getElementById('manha-max').value);
                const manhaAtual = document.getElementById('manha-atual').value.trim() === '' ? null : parseFloat(document.getElementById('manha-atual').value);
                const tardeMin = document.getElementById('tarde-min').value.trim() === '' ? null : parseFloat(document.getElementById('tarde-min').value);
                const tardeMax = document.getElementById('tarde-max').value.trim() === '' ? null : parseFloat(document.getElementById('tarde-max').value);
                const tardeAtual = document.getElementById('tarde-atual').value.trim() === '' ? null : parseFloat(document.getElementById('tarde-atual').value);
        
                if (validateDado(manhaMin, manhaMax, manhaAtual, tardeMin, tardeMax, tardeAtual) && data && mnemonicoId && responsavelId) {
                    const newDado = {
                        data,
                        mnemonicoId,
                        responsavelId,
                        manhaMin,
                        manhaMax,
                        manhaAtual,
                        tardeMin,
                        tardeMax,
                        tardeAtual,
                        annotation: null
                    };
                    dados.unshift(newDado);
                    dados.sort((a, b) => new Date(b.data) - new Date(a.data));
                    if (dados.length > 5000) {
                        const oldest = dados.slice(-1)[0];
                        const index = dados.findIndex(item => item === oldest);
                        dados.splice(index, 1);
                        console.log(`Registro mais antigo removido. Novo total de registros: ${dados.length}`);
                    }
                    await saveToJsonBin();
                    currentPage = 1;
                    renderDadosCards();
                    renderPagination();
                    renderDashboardTable();
                    showSuccessAlert();
                    if (manhaAtual === null && tardeAtual === null) {
                        const globalIndex = dados.findIndex(d =>
                            d.data === newDado.data &&
                            d.mnemonicoId === newDado.mnemonicoId &&
                            d.responsavelId === newDado.responsavelId
                        );
                        if (globalIndex !== -1) {
                            openAnnotationModal(globalIndex);
                        }
                    }
                    clearDadosForm();
                    redirectToDashboard();
                } else {
                    alert('Por favor, corrija os campos inválidos (data, mnemonico e responsável são obrigatórios).');
                }
            } catch (error) {
                console.error('Erro ao adicionar dado:', error);
                alert('Erro ao salvar os dados no servidor.');
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
                button.textContent = 'Adicionar';
            }
        }
        
        // Função para validar dados puramente no modelo
        function validateDadoByIndex(index) {
            if (index < 0 || index >= dados.length || !dados[index]) {
                return { valid: false, invalidFields: [] };
            }
        
            const item = dados[index];
            const manhaMin = item.manhaMin;
            const manhaMax = item.manhaMax;
            const manhaAtual = item.manhaAtual;
            const tardeMin = item.tardeMin;
            const tardeMax = item.tardeMax;
            const tardeAtual = item.tardeAtual;
        
            let valid = true;
            const invalidFields = [];
        
            if (manhaMin !== null && manhaMax !== null && manhaAtual !== null) {
                if (manhaMin > manhaAtual || manhaMin > manhaMax) {
                    invalidFields.push('manhaMin');
                    valid = false;
                }
                if (manhaMax < manhaAtual || manhaMax < manhaMin) {
                    invalidFields.push('manhaMax');
                    valid = false;
                }
                if (manhaAtual < manhaMin || manhaAtual > manhaMax) {
                    invalidFields.push('manhaAtual');
                    valid = false;
                }
            } else if (manhaMin !== null && manhaAtual === null) {
                invalidFields.push('manhaMin');
                valid = false;
            } else if (manhaMax !== null && manhaAtual === null) {
                invalidFields.push('manhaMax');
                valid = false;
            }
        
            if (tardeMin !== null && tardeMax !== null && tardeAtual !== null) {
                if (tardeMin > tardeAtual || tardeMin > tardeMax) {
                    invalidFields.push('tardeMin');
                    valid = false;
                }
                if (tardeMax < tardeAtual || tardeMax < tardeMin) {
                    invalidFields.push('tardeMax');
                    valid = false;
                }
                if (tardeAtual < tardeMin || tardeAtual > tardeMax) {
                    invalidFields.push('tardeAtual');
                    valid = false;
                }
            } else if (tardeMin !== null && tardeAtual === null) {
                invalidFields.push('tardeMin');
                valid = false;
            } else if (tardeMax !== null && tardeAtual === null) {
                invalidFields.push('tardeMax');
                valid = false;
            }
        
            return { valid, invalidFields };
        }
        
        function clearDadosForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('data').value = today;
            document.getElementById('dados-mnemonico').value = '';
            document.getElementById('dados-responsavel').value = '';
            document.getElementById('manha-min').value = '';
            document.getElementById('manha-max').value = '';
            document.getElementById('manha-atual').value = '';
            document.getElementById('tarde-min').value = '';
            document.getElementById('tarde-max').value = '';
            document.getElementById('tarde-atual').value = '';
            const inputs = ['manha-min', 'manha-max', 'manha-atual', 'tarde-min', 'tarde-max', 'tarde-atual', 'dados-mnemonico', 'dados-responsavel'];
            inputs.forEach(id => {
                document.getElementById(id).classList.remove('invalid');
            });
        }
        
        function renderDadosCards() {
            console.log(`Total de registros em dados: ${dados.length}/5000`);
            const cardsContainer = document.getElementById('dados-cards');
            cardsContainer.innerHTML = '';
            const filteredDados = dados.sort((a, b) => {
                const dateA = new Date(a.data);
                const dateB = new Date(b.data);
                dateA.setMinutes(dateA.getMinutes() + dateA.getTimezoneOffset());
                dateB.setMinutes(dateB.getMinutes() + dateB.getTimezoneOffset());
                const dateComparison = dateB - dateA;
                if (dateComparison !== 0) return dateComparison;
                const mnemonicoA = mnemonicos.find(m => m.id === a.mnemonicoId)?.mnemonico || '';
                const mnemonicoB = mnemonicos.find(m => m.id === b.mnemonicoId)?.mnemonico || '';
                return mnemonicoA.localeCompare(mnemonicoB);
            });
            const start = (currentPage - 1) * itemsPerPage;
            const paginatedDados = filteredDados.slice(start, start + itemsPerPage);
        
            paginatedDados.forEach((item, localIndex) => {
                const globalIndex = dados.findIndex(d => 
                    d.data === item.data &&
                    d.mnemonicoId === item.mnemonicoId &&
                    d.responsavelId === item.responsavelId
                );
        
                if (globalIndex === -1) {
                    console.warn('Índice global não encontrado para o item:', item);
                    return;
                }
        
                const mnemonico = mnemonicos.find(m => m.id === item.mnemonicoId)?.mnemonico || 'Desconhecido';
                const responsavel = responsaveis.find(r => r.id === item.responsavelId)?.name || 'Desconhecido';
        
                const card = document.createElement('div');
                card.className = 'dados-card';
                card.innerHTML = `
                    <div class="field">
                        <label>Data</label>
                        <input type="date" value="${item.data}" onchange="updateDado(${globalIndex}, 'data', this.value)">
                    </div>
                    <div class="field">
                        <label>Mnemonico</label>
                        <input type="text" value="${mnemonico}" readonly>
                    </div>
                    <div class="field">
                        <label>Responsável</label>
                        <input type="text" value="${responsavel}" readonly>
                    </div>
                    <div class="field">
                        <label>⛅ Min ºC</label>
                        <input type="number" step="0.1" value="${item.manhaMin !== null ? item.manhaMin : ''}" onchange="updateDado(${globalIndex}, 'manhaMin', this.value.trim() === '' ? null : parseFloat(this.value))">
                    </div>
                    <div class="field">
                        <label>⛅ Max ºC</label>
                        <input type="number" step="0.1" value="${item.manhaMax !== null ? item.manhaMax : ''}" onchange="updateDado(${globalIndex}, 'manhaMax', this.value.trim() === '' ? null : parseFloat(this.value))">
                    </div>
                    <div class="field">
                        <label>⛅ Atual ºC</label>
                        <input type="number" step="0.1" value="${item.manhaAtual !== null ? item.manhaAtual : ''}" onchange="updateDado(${globalIndex}, 'manhaAtual', this.value.trim() === '' ? null : parseFloat(this.value))">
                    </div>
                    <div class="field">
                        <label>🌞 Min ºC</label>
                        <input type="number" step="0.1" value="${item.tardeMin !== null ? item.tardeMin : ''}" onchange="updateDado(${globalIndex}, 'tardeMin', this.value.trim() === '' ? null : parseFloat(this.value))">
                    </div>
                    <div class="field">
                        <label>🌞 Max ºC</label>
                        <input type="number" step="0.1" value="${item.tardeMax !== null ? item.tardeMax : ''}" onchange="updateDado(${globalIndex}, 'tardeMax', this.value.trim() === '' ? null : parseFloat(this.value))">
                    </div>
                    <div class="field">
                        <label>🌞 Atual ºC</label>
                        <input type="number" step="0.1" value="${item.tardeAtual !== null ? item.tardeAtual : ''}" onchange="updateDado(${globalIndex}, 'tardeAtual', this.value.trim() === '' ? null : parseFloat(this.value))">
                    </div>
                    <button class="delete-card" onclick="deleteDado(${globalIndex})">&#10006;</button>
                    <i class="fas fa-sticky-note annotation-icon ${item.annotation ? 'has-note' : ''}" onclick="openAnnotationModal(${globalIndex})"></i>
                `;
                cardsContainer.appendChild(card);
        
                validateCard(globalIndex);
            });
            renderPagination();
        }
        
        async function updateDado(index, field, value) {
            const filteredDados = dados.sort((a, b) => {
                const dateA = new Date(a.data);
                const dateB = new Date(b.data);
                dateA.setMinutes(dateA.getMinutes() + dateA.getTimezoneOffset());
                dateB.setMinutes(dateB.getMinutes() + dateB.getTimezoneOffset());
                const dateComparison = dateB - dateA;
                if (dateComparison !== 0) return dateComparison;
                const mnemonicoA = mnemonicos.find(m => m.id === a.mnemonicoId)?.mnemonico || '';
                const mnemonicoB = mnemonicos.find(m => m.id === b.mnemonicoId)?.mnemonico || '';
                return mnemonicoA.localeCompare(mnemonicoB);
            });
        
            const start = (currentPage - 1) * itemsPerPage;
            const paginatedDados = filteredDados.slice(start, start + itemsPerPage);
            const cardIndex = paginatedDados.findIndex(d => 
                d.data === dados[index].data &&
                d.mnemonicoId === dados[index].mnemonicoId &&
                d.responsavelId === dados[index].responsavelId
            );
        
            let card = null;
            if (cardIndex !== -1) {
                const cards = document.querySelectorAll('.dados-card');
                if (cardIndex < cards.length) {
                    card = cards[cardIndex];
                    card.classList.add('loading');
                    card.style.opacity = '0.7';
                    card.style.transition = 'opacity 0.3s ease';
                }
            }
        
            try {
                if (['manhaMin', 'manhaMax', 'manhaAtual', 'tardeMin', 'tardeMax', 'tardeAtual'].includes(field)) {
                    dados[index][field] = value === '' ? null : parseFloat(value);
                } else if (field === 'data') {
                    dados[index][field] = value;
                }
        
                const isValid = validateCard(index);
        
                const manhaAtual = dados[index].manhaAtual;
                const tardeAtual = dados[index].tardeAtual;
                const manhaMin = dados[index].manhaMin;
                const manhaMax = dados[index].manhaMax;
                const tardeMin = dados[index].tardeMin;
                const tardeMax = dados[index].tardeMax;
        
                const canSendManha = manhaAtual !== null && (
                    (manhaMin === null && manhaMax === null) ||
                    (manhaMin !== null && manhaMax !== null && isValid)
                );
                const canSendTarde = tardeAtual !== null && (
                    (tardeMin === null && tardeMax === null) ||
                    (tardeMin !== null && tardeMax !== null && isValid)
                );
        
                if (isValid && (canSendManha || canSendTarde || field === 'data')) {
                    await saveToJsonBin();
                    renderDadosCards();
                    renderDashboardTable();
                    updateCharts();
                    showSuccessAlert();
                    redirectToDashboard();
                } else {
                    renderDadosCards();
                    showAlert();
                }
            } catch (error) {
                console.error('Erro ao atualizar dado:', error);
                renderDadosCards();
            } finally {
                if (card) {
                    card.classList.remove('loading');
                    card.style.opacity = '1';
                }
            }
        }
        
        function validateCard(globalIndex) {
            const validation = validateDadoByIndex(globalIndex);
            if (!validation.valid) {
                console.warn(`Validação falhou para o índice ${globalIndex}:`, validation.invalidFields);
            }
        
            const filteredDados = dados.sort((a, b) => {
                const dateA = new Date(a.data);
                const dateB = new Date(b.data);
                dateA.setMinutes(dateA.getMinutes() + dateA.getTimezoneOffset());
                dateB.setMinutes(dateB.getMinutes() + dateB.getTimezoneOffset());
                const dateComparison = dateB - dateA;
                if (dateComparison !== 0) return dateComparison;
                const mnemonicoA = mnemonicos.find(m => m.id === a.mnemonicoId)?.mnemonico || '';
                const mnemonicoB = mnemonicos.find(m => m.id === b.mnemonicoId)?.mnemonico || '';
                return mnemonicoA.localeCompare(mnemonicoB);
            });
        
            const start = (currentPage - 1) * itemsPerPage;
            const paginatedDados = filteredDados.slice(start, start + itemsPerPage);
            const cardIndex = paginatedDados.findIndex(d => 
                d && 
                d.data === dados[globalIndex].data &&
                d.mnemonicoId === dados[globalIndex].mnemonicoId &&
                d.responsavelId === dados[globalIndex].responsavelId
            );
        
            if (cardIndex !== -1) {
                const cards = document.querySelectorAll('.dados-card');
                if (cardIndex < cards.length) {
                    const card = cards[cardIndex];
        
                    const fieldSelectors = {
                        manhaMin: 'input[onchange*="\'manhaMin\'"]',
                        manhaMax: 'input[onchange*="\'manhaMax\'"]',
                        manhaAtual: 'input[onchange*="\'manhaAtual\'"]',
                        tardeMin: 'input[onchange*="\'tardeMin\'"]',
                        tardeMax: 'input[onchange*="\'tardeMax\'"]',
                        tardeAtual: 'input[onchange*="\'tardeAtual\'"]'
                    };
        
                    Object.values(fieldSelectors).forEach(selector => {
                        const input = card.querySelector(selector);
                        if (input) input.classList.remove('invalid');
                    });
        
                    validation.invalidFields.forEach(field => {
                        const input = card.querySelector(fieldSelectors[field]);
                        if (input) input.classList.add('invalid');
                    });
                }
            }
        
            return validation.valid;
        }
        
        async function deleteDado(index) {
    const cards = document.querySelectorAll('.dados-card');
    const localIndex = index % itemsPerPage;
    const card = cards[localIndex];
    const button = card ? card.querySelector('.delete-card') : null;

    if (card) {
        card.classList.add('loading');
        card.style.opacity = '0.7';
        card.style.transition = 'opacity 0.3s ease';
    }

    if (button) {
        button.disabled = true;
        button.innerHTML = '<span class="spinner"></span>';
    }

    try {
        dados.splice(index, 1);
        if (currentPage > Math.ceil(dados.length / itemsPerPage)) {
            currentPage = Math.max(1, Math.ceil(dados.length / itemsPerPage));
        }
        dados.sort((a, b) => new Date(b.data) - new Date(a.data));
        await saveToJsonBin();
        renderDadosCards();
        renderPagination();
        renderDashboardTable();
        redirectToDashboard();
    } catch (error) {
        console.error('Erro ao deletar dado:', error);
        alert('Erro ao deletar o dado no servidor.');
    } finally {
        if (card) {
            card.classList.remove('loading');
            card.style.opacity = '1';
        }
        if (button) {
            button.disabled = false;
            button.innerHTML = '&#10006;';
        }
    }
}

        function renderPagination() {
            const paginationContainer = document.getElementById('pagination');
            paginationContainer.innerHTML = '';
            const totalPages = Math.ceil(dados.length / itemsPerPage);
        
            if (totalPages <= 1) return;
        
            const firstButton = document.createElement('button');
            firstButton.textContent = '<';
            firstButton.className = 'first-page';
            firstButton.disabled = currentPage === 1;
            firstButton.addEventListener('click', () => {
                currentPage = 1;
                renderDadosCards();
                renderPagination();
            });
            paginationContainer.appendChild(firstButton);
        
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesDisplayed / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesDisplayed - 1);
        
            if (endPage - startPage + 1 < maxPagesDisplayed) {
                startPage = Math.max(1, endPage - maxPagesDisplayed + 1);
            }
        
            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = i === currentPage ? 'active' : '';
                button.addEventListener('click', () => {
                    currentPage = i;
                    renderDadosCards();
                    renderPagination();
                });
                paginationContainer.appendChild(button);
            }
        
            const lastButton = document.createElement('button');
            lastButton.textContent = '>';
            lastButton.disabled = currentPage === totalPages;
            lastButton.addEventListener('click', () => {
                currentPage = totalPages;
                renderDadosCards();
                renderPagination();
            });
            paginationContainer.appendChild(lastButton);
        }
        
        function saveDashboardFilters() {
            const filters = {
                mes: document.getElementById('filter-mes').value,
                ano: document.getElementById('filter-ano').value,
                mnemonicoId: document.getElementById('filter-mnemonico').value
            };
            localStorage.setItem(`dashboardFilters_${selectedUnitId}`, JSON.stringify(filters));
        }
        
        function loadDashboardFilters() {
            const savedFilters = localStorage.getItem(`dashboardFilters_${selectedUnitId}`);
            if (savedFilters) {
                const filters = JSON.parse(savedFilters);
                document.getElementById('filter-mes').value = filters.mes || '';
                document.getElementById('filter-ano').value = filters.ano || '';
                document.getElementById('filter-mnemonico').value = filters.mnemonicoId || '';
        
                if (filters.mnemonicoId) {
                    const mnemonicoData = mnemonicos.find(item => item.id === parseInt(filters.mnemonicoId));
                    if (mnemonicoData) {
                        document.getElementById('mnemonico-tipo').textContent = mnemonicoData.tipo;
                        document.getElementById('mnemonico-legenda').textContent = mnemonicoData.legenda;
                        document.getElementById('mnemonico-min').textContent = mnemonicoData.min.toFixed(1);
                        document.getElementById('mnemonico-max').textContent = mnemonicoData.max.toFixed(1);
                    }
                }
            }
        }
        
        function toggleCadastroSection(section) {
            document.getElementById('mnemonicos-section').classList.add('hidden');
            document.getElementById('responsaveis-section').classList.add('hidden');
        
            document.querySelectorAll('.toggle-button').forEach(btn => {
                btn.classList.remove('active');
            });
        
            const sectionElement = document.getElementById(`${section}-section`);
            sectionElement.classList.remove('hidden');
        
            const button = event.target.closest('.toggle-button');
            button.classList.add('active');
        }
        
        function formatDateBR(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            return `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
        }
        
        function createCharts() {
            createManhaChart();
            createTardeChart();
        }
        
        function createManhaChart() {
            const ctx = document.getElementById('manhaChart').getContext('2d');
            if (manhaChart) {
                manhaChart.destroy();
            }
        
            const filteredDados = getFilteredDataForCharts();
            const mnemonicoData = getCurrentMnemonicoData();
        
            const validDados = filteredDados.filter(item => 
                item.manhaMin !== null || item.manhaMax !== null || item.manhaAtual !== null
            );
        
            manhaChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: validDados.map(item => formatDateBR(item.data)),
                    datasets: [
                        {
                            label: 'Min ºC',
                            data: validDados.map(item => item.manhaMin !== null ? item.manhaMin : null),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            spanGaps: true
                        },
                        {
                            label: 'Max ºC',
                            data: validDados.map(item => item.manhaMax !== null ? item.manhaMax : null),
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            spanGaps: true
                        },
                        {
                            label: 'Atual ºC',
                            data: validDados.map(item => item.manhaAtual !== null ? item.manhaAtual : null),
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        annotation: {
                            annotations: mnemonicoData ? [
                                {
                                    type: 'line',
                                    yMin: mnemonicoData.min,
                                    yMax: mnemonicoData.min,
                                    borderColor: '#bf0000',
                                    borderWidth: 2,
                                    borderDash: [],
                                    label: {
                                        content: `Min Ideal: ${mnemonicoData.min}ºC`,
                                        enabled: true,
                                        position: 'start',
                                        backgroundColor: 'rgba(0,0,0,0.8)',
                                        color: '#fff',
                                        padding: 6,
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                {
                                    type: 'line',
                                    yMin: mnemonicoData.max,
                                    yMax: mnemonicoData.max,
                                    borderColor: '#bf0000',
                                    borderWidth: 2,
                                    borderDash: [],
                                    label: {
                                        content: `Max Ideal: ${mnemonicoData.max}ºC`,
                                        enabled: true,
                                        position: 'start',
                                        backgroundColor: 'rgba(0,0,0,0.8)',
                                        color: '#fff',
                                        padding: 6,
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            ] : []
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Temperatura (ºC)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data'
                            },
                            ticks: {
                                autoSkip: false
                            }
                        }
                    }
                }
            });
        }
        
        function createTardeChart() {
            const ctx = document.getElementById('tardeChart').getContext('2d');
            if (tardeChart) {
                tardeChart.destroy();
            }
        
            const filteredDados = getFilteredDataForCharts();
            const mnemonicoData = getCurrentMnemonicoData();
        
            const validDados = filteredDados.filter(item => 
                item.tardeMin !== null || item.tardeMax !== null || item.tardeAtual !== null
            );
        
            tardeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: validDados.map(item => formatDateBR(item.data)),
                    datasets: [
                        {
                            label: 'Min ºC',
                            data: validDados.map(item => item.tardeMin !== null ? item.tardeMin : null),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            spanGaps: true
                        },
                        {
                            label: 'Max ºC',
                            data: validDados.map(item => item.tardeMax !== null ? item.tardeMax : null),
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            spanGaps: true
                        },
                        {
                            label: 'Atual ºC',
                            data: validDados.map(item => item.tardeAtual !== null ? item.tardeAtual : null),
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        annotation: {
                            annotations: mnemonicoData ? [
                                {
                                    type: 'line',
                                    yMin: mnemonicoData.min,
                                    yMax: mnemonicoData.min,
                                    borderColor: '#bf0000',
                                    borderWidth: 2,
                                    borderDash: [],
                                    label: {
                                        content: `Min Ideal: ${mnemonicoData.min}ºC`,
                                        enabled: true,
                                        position: 'start',
                                        backgroundColor: 'rgba(0,0,0,0.8)',
                                        color: '#fff',
                                        padding: 6,
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                {
                                    type: 'line',
                                    yMin: mnemonicoData.max,
                                    yMax: mnemonicoData.max,
                                    borderColor: '#bf0000',
                                    borderWidth: 2,
                                    borderDash: [],
                                    label: {
                                        content: `Max Ideal: ${mnemonicoData.max}ºC`,
                                        enabled: true,
                                        position: 'start',
                                        backgroundColor: 'rgba(0,0,0,0.8)',
                                        color: '#fff',
                                        padding: 6,
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            ] : []
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Temperatura (ºC)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data'
                            },
                            ticks: {
                                autoSkip: false
                            }
                        }
                    }
                }
            });
        }
        
        function getFilteredDataForCharts() {
            const mes = document.getElementById('filter-mes').value;
            const ano = document.getElementById('filter-ano').value;
            const mnemonicoId = parseInt(document.getElementById('filter-mnemonico').value);
        
            if (!mes || !ano || !mnemonicoId) {
                return [];
            }
        
            return dados.filter(item => {
                const [itemYear, itemMonth] = item.data.split('-').map(Number);
                return itemMonth === parseInt(mes) &&
                       itemYear === parseInt(ano) &&
                       item.mnemonicoId === mnemonicoId;
            }).sort((a, b) => a.data.localeCompare(b.data));
        }
        
        function getCurrentMnemonicoData() {
            const mnemonicoId = parseInt(document.getElementById('filter-mnemonico').value);
            return mnemonicos.find(m => m.id === mnemonicoId);
        }
        
        function updateCharts() {
            if (manhaChart && tardeChart) {
                createManhaChart();
                createTardeChart();
            }
        }
        
        function renderDashboardFilters() {
            const anoSelect = document.getElementById('filter-ano');
            const currentYear = new Date().getFullYear();
            anoSelect.innerHTML = '<option value="">Selecione</option>';
            for (let i = currentYear; i >= currentYear - 2; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                anoSelect.appendChild(option);
            }
        
            const savedFilters = localStorage.getItem(`dashboardFilters_${selectedUnitId}`);
            if (!savedFilters) {
                anoSelect.value = currentYear;
                saveDashboardFilters();
            }
        
            document.getElementById('filter-mnemonico').addEventListener('change', function() {
                const mnemonicoId = parseInt(this.value);
                const mnemonicoData = mnemonicos.find(item => item.id === mnemonicoId);
                document.getElementById('mnemonico-tipo').textContent = mnemonicoData ? mnemonicoData.tipo : '';
                document.getElementById('mnemonico-legenda').textContent = mnemonicoData ? mnemonicoData.legenda : '';
                document.getElementById('mnemonico-min').textContent = mnemonicoData ? mnemonicoData.min.toFixed(1) : '';
                document.getElementById('mnemonico-max').textContent = mnemonicoData ? mnemonicoData.max.toFixed(1) : '';
                saveDashboardFilters();
                renderDashboardTable();
            });
        
            document.getElementById('filter-mes').addEventListener('change', function() {
                saveDashboardFilters();
                renderDashboardTable();
            });
        
            document.getElementById('filter-ano').addEventListener('change', function() {
                saveDashboardFilters();
                renderDashboardTable();
            });
        }
        
        function renderDashboardTable() {
            const mes = document.getElementById('filter-mes').value;
            const ano = document.getElementById('filter-ano').value;
            const mnemonicoId = parseInt(document.getElementById('filter-mnemonico').value);
            const tbody = document.querySelector('#dashboard-table tbody');
            tbody.innerHTML = '';
        
            if (!mes || !ano || !mnemonicoId) {
                return;
            }
        
            const filteredDados = dados.filter(item => {
                const [itemYear, itemMonth] = item.data.split('-').map(Number);
                return itemMonth === parseInt(mes) &&
                       itemYear === parseInt(ano) &&
                       item.mnemonicoId === mnemonicoId;
            }).sort((a, b) => {
                const dateComparison = b.data.localeCompare(a.data);
                if (dateComparison !== 0) return dateComparison;
                const mnemonicoA = mnemonicos.find(m => m.id === a.mnemonicoId)?.mnemonico || '';
                const mnemonicoB = mnemonicos.find(m => m.id === b.mnemonicoId)?.mnemonico || '';
                return mnemonicoA.localeCompare(mnemonicoB);
            });
        
            filteredDados.forEach((item, index) => {
                const globalIndex = dados.findIndex(d => 
                    d.data === item.data &&
                    d.mnemonicoId === item.mnemonicoId &&
                    d.responsavelId === item.responsavelId
                );
        
                if (globalIndex === -1) {
                    console.error('Índice global não encontrado para o item:', item);
                    return;
                }
        
                const row = document.createElement('tr');
        
                const mnemonicoData = mnemonicos.find(m => m.id === item.mnemonicoId);
                const responsavel = responsaveis.find(r => r.id === item.responsavelId)?.name || 'Desconhecido';
                const mnemonico = mnemonicoData ? mnemonicoData.mnemonico : 'Desconhecido';
        
                let manhaMinClass = '', manhaMaxClass = '', manhaAtualClass = '';
                let tardeMinClass = '', tardeMaxClass = '', tardeAtualClass = '';
                if (mnemonicoData) {
                    if (item.manhaMin !== null) {
                        if (item.manhaMin < mnemonicoData.min - 1 || item.manhaMin > mnemonicoData.max + 1) {
                            manhaMinClass = 'out-of-range';
                        } else if (item.manhaMin >= mnemonicoData.min - 1 && item.manhaMin <= mnemonicoData.min ||
                                   item.manhaMin >= mnemonicoData.max && item.manhaMin <= mnemonicoData.max + 1) {
                            manhaMinClass = 'at-limit';
                        }
                    }
        
                    if (item.manhaMax !== null) {
                        if (item.manhaMax < mnemonicoData.min - 1 || item.manhaMax > mnemonicoData.max + 1) {
                            manhaMaxClass = 'out-of-range';
                        } else if (item.manhaMax >= mnemonicoData.min - 1 && item.manhaMax <= mnemonicoData.min ||
                                   item.manhaMax >= mnemonicoData.max && item.manhaMax <= mnemonicoData.max + 1) {
                            manhaMaxClass = 'at-limit';
                        }
                    }
        
                    if (item.manhaAtual !== null) {
                        if (item.manhaAtual < mnemonicoData.min - 1 || item.manhaAtual > mnemonicoData.max + 1) {
                            manhaAtualClass = 'out-of-range';
                        } else if (item.manhaAtual >= mnemonicoData.min - 1 && item.manhaAtual <= mnemonicoData.min ||
                                   item.manhaAtual >= mnemonicoData.max && item.manhaAtual <= mnemonicoData.max + 1) {
                            manhaAtualClass = 'at-limit';
                        }
                    }
        
                    if (item.tardeMin !== null) {
                        if (item.tardeMin < mnemonicoData.min - 1 || item.tardeMin > mnemonicoData.max + 1) {
                            tardeMinClass = 'out-of-range';
                        } else if (item.tardeMin >= mnemonicoData.min - 1 && item.tardeMin <= mnemonicoData.min ||
                                   item.tardeMin >= mnemonicoData.max && item.tardeMin <= mnemonicoData.max + 1) {
                            tardeMinClass = 'at-limit';
                        }
                    }
        
                    if (item.tardeMax !== null) {
                        if (item.tardeMax < mnemonicoData.min - 1 || item.tardeMax > mnemonicoData.max + 1) {
                            tardeMaxClass = 'out-of-range';
                        } else if (item.tardeMax >= mnemonicoData.min - 1 && item.tardeMax <= mnemonicoData.min ||
                                   item.tardeMax >= mnemonicoData.max && item.tardeMax <= mnemonicoData.max + 1) {
                            tardeMaxClass = 'at-limit';
                        }
                    }
        
                    if (item.tardeAtual !== null) {
                        if (item.tardeAtual < mnemonicoData.min - 1 || item.tardeAtual > mnemonicoData.max + 1) {
                            tardeAtualClass = 'out-of-range';
                        } else if (item.tardeAtual >= mnemonicoData.min - 1 && item.tardeAtual <= mnemonicoData.min ||
                                   item.tardeAtual >= mnemonicoData.max && item.tardeAtual <= mnemonicoData.max + 1) {
                            tardeAtualClass = 'at-limit';
                        }
                    }
                }
        
                row.innerHTML = `
                    <td>
                        ${formatDateBR(item.data)}
                        ${item.annotation ? `<span><i class="fas fa-sticky-note annotation-icon-table has-note" onclick="openAnnotationViewModal(${globalIndex})"></i></span>` : ''}
                    </td>
                    <td>${mnemonico}</td>
                    <td>${responsavel}</td>
                    <td class="${manhaMinClass}">${item.manhaMin !== null ? item.manhaMin.toFixed(1) : '-'}</td>
                    <td class="${manhaMaxClass}">${item.manhaMax !== null ? item.manhaMax.toFixed(1) : '-'}</td>
                    <td class="${manhaAtualClass}">${item.manhaAtual !== null ? item.manhaAtual.toFixed(1) : '-'}</td>
                    <td class="${tardeMinClass}">${item.tardeMin !== null ? item.tardeMin.toFixed(1) : '-'}</td>
                    <td class="${tardeMaxClass}">${item.tardeMax !== null ? item.tardeMax.toFixed(1) : '-'}</td>
                    <td class="${tardeAtualClass}">${item.tardeAtual !== null ? item.tardeAtual.toFixed(1) : '-'}</td>
                `;
                tbody.appendChild(row);
            });
        
            updateCharts();
        }
        
        let currentAnnotationIndex = null;
        
        function openAnnotationModal(index) {
            currentAnnotationIndex = index;
            const modal = document.getElementById('annotation-modal');
            const textarea = document.getElementById('annotation-text');
            textarea.value = dados[index].annotation || '';
            modal.style.display = 'flex';
        }
        
        function closeAnnotationModal() {
            document.getElementById('annotation-modal').style.display = 'none';
            currentAnnotationIndex = null;
        }
        
        async function saveAnnotation() {
            if (currentAnnotationIndex === null) return;
            const textarea = document.getElementById('annotation-text');
            const addButton = document.querySelector('#annotation-modal button[onclick="saveAnnotation()"]');
            addButton.classList.add('loading');
            addButton.disabled = true;
            addButton.textContent = 'Adicionando';
        
            try {
                const annotation = textarea.value.trim();
                dados[currentAnnotationIndex].annotation = annotation || null;
                await saveToJsonBin();
                renderDadosCards();
                renderDashboardTable();
                closeAnnotationModal();
                redirectToDashboard();
            } catch (error) {
                console.error('Erro ao salvar anotação:', error);
                alert('Erro ao salvar a anotação no servidor.');
            } finally {
                addButton.classList.remove('loading');
                addButton.disabled = false;
                addButton.textContent = 'Adicionar';
            }
        }
        
        async function deleteAnnotation() {
            if (currentAnnotationIndex === null) return;
            const deleteButton = document.querySelector('#annotation-modal button[onclick="deleteAnnotation()"]');
            deleteButton.classList.add('loading');
            deleteButton.disabled = true;
            deleteButton.textContent = 'Apagando';
        
            try {
                dados[currentAnnotationIndex].annotation = null;
                await saveToJsonBin();
                renderDadosCards();
                renderDashboardTable();
                closeAnnotationModal();
                redirectToDashboard();
            } catch (error) {
                console.error('Erro ao deletar anotação:', error);
                alert('Erro ao deletar a anotação no servidor.');
            } finally {
                deleteButton.classList.remove('loading');
                deleteButton.disabled = false;
                deleteButton.textContent = 'Apagar';
            }
        }
        
        function openAnnotationViewModal(index) {
            const modal = document.getElementById('annotation-view-modal');
            const textDiv = document.getElementById('annotation-view-text');
            const annotationText = dados[index] ? (dados[index].annotation || 'Nenhuma anotação disponível.') : 'Nenhuma anotação disponível.';
            textDiv.textContent = annotationText;
            modal.style.display = 'flex';
        }
        
        function closeAnnotationViewModal() {
            document.getElementById('annotation-view-modal').style.display = 'none';
        }
        
        async function init() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('data').value = today;
        
            selectedUnitId = null;
            localStorage.removeItem('selectedUnitId');
            updateUnitDisplay();
        
            document.getElementById('responsaveis-section').classList.add('hidden');
            document.querySelector('.toggle-button').classList.add('active');
            renderDashboardFilters();
            toggleLoadingScreen(false);
            openUnitModal();
        }
        
        init();
        
        const tabs = document.querySelectorAll('.tab-button');
        const contents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', async (e) => {
                clearDadosTabTimer();
                if (tab.dataset.tab === 'dados') {
                    e.preventDefault();
                    if (!selectedUnitId) {
                        alert('Por favor, selecione uma unidade antes de acessar a aba Dados.');
                        openUnitModal();
                        return;
                    }
                    try {
                        toggleLoadingScreen(true);
                        await loadFromJsonBin();
                        tabs.forEach(t => t.classList.remove('active'));
                        contents.forEach(c => c.classList.remove('active'));
                        tab.classList.add('active');
                        document.getElementById('dados').classList.add('active');
                        renderDropdowns();
                        renderPagination();
                        startDadosTabTimer();
                    } catch (error) {
                        console.error('Erro ao carregar dados:', error);
                        alert('Erro ao carregar os dados do servidor.');
                    } finally {
                        toggleLoadingScreen(false);
                    }
                } else if (tab.dataset.tab === 'cadastro') {
                    e.preventDefault();
                    if (!selectedUnitId) {
                        alert('Por favor, selecione uma unidade antes de acessar a aba Cadastro.');
                        openUnitModal();
                        return;
                    }
                    if (isCadastroAccessible) {
                        tabs.forEach(t => t.classList.remove('active'));
                        contents.forEach(c => c.classList.remove('active'));
                        tab.classList.add('active');
                        document.getElementById('cadastro').classList.add('active');
                        renderMnemonicos();
                        renderResponsaveis();
                    } else {
                        openPasswordModal();
                    }
                } else {
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    const target = document.getElementById(tab.dataset.tab);
                    target.classList.add('active');
        
                    if (tab.dataset.tab === 'dashboard') {
                        if (!selectedUnitId) {
                            openUnitModal();
                            return;
                        }
                        renderDashboardFilters();
                        loadDashboardFilters();
                        renderDashboardTable();
                    }
                }
            });
        });
        
        function validateForm() {
            const manhaMin = document.getElementById('manha-min').value.trim() === '' ? null : parseFloat(document.getElementById('manha-min').value);
            const manhaMax = document.getElementById('manha-max').value.trim() === '' ? null : parseFloat(document.getElementById('manha-max').value);
            const manhaAtual = document.getElementById('manha-atual').value.trim() === '' ? null : parseFloat(document.getElementById('manha-atual').value);
            const tardeMin = document.getElementById('tarde-min').value.trim() === '' ? null : parseFloat(document.getElementById('tarde-min').value);
            const tardeMax = document.getElementById('tarde-max').value.trim() === '' ? null : parseFloat(document.getElementById('tarde-max').value);
            const tardeAtual = document.getElementById('tarde-atual').value.trim() === '' ? null : parseFloat(document.getElementById('tarde-atual').value);
            validateDado(manhaMin, manhaMax, manhaAtual, tardeMin, tardeMax, tardeAtual);
        }
        
        function showAlert() {
            const alertElement = document.getElementById('alert-message');
            alertElement.classList.remove('hidden');
            alertElement.classList.add('visible');
        
            setTimeout(() => {
                alertElement.classList.remove('visible');
                setTimeout(() => {
                    alertElement.classList.add('hidden');
                }, 1500);
            }, 5000);
        }
        
        function showSuccessAlert() {
            const alertElement = document.getElementById('alert-message-success');
            alertElement.classList.remove('hidden');
            alertElement.classList.add('visible');
        
            setTimeout(() => {
                alertElement.classList.remove('visible');
                setTimeout(() => {
                    alertElement.classList.add('hidden');
                }, 1500);
            }, 5000);
        }
        
        function toggleLoadingScreen(show) {
            const loadingScreen = document.getElementById('loading-screen');
            if (show) {
                loadingScreen.style.display = 'flex';
                loadingScreen.classList.remove('hidden');
            } else {
                loadingScreen.classList.add('hidden');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }
        }
        
                const CORRECT_PASSWORD = 'Lamic6530@';
                let isCadastroAccessible = false;
                
                function openPasswordModal() {
                    const modal = document.getElementById('password-modal');
                    const input = document.getElementById('password-input');
                    const confirmButton = document.querySelector('#password-modal button:not(.close-modal)');
                
                    input.value = '';
                    input.classList.remove('invalid');
                    confirmButton.classList.remove('invalid');
                    modal.querySelector('.password-modal-content').classList.remove('shake');
                    modal.style.display = 'flex';
                    input.focus();
                }
                
                function closePasswordModal() {
                    document.getElementById('password-modal').style.display = 'none';
                    redirectToDashboard();
                }
                
                function checkPassword() {
                    const input = document.getElementById('password-input');
                    const confirmButton = document.querySelector('#password-modal button:not(.close-modal)');
                    const modalContent = document.querySelector('.password-modal-content');
                    const password = input.value.trim();
                
                    if (password === CORRECT_PASSWORD) {
                        isCadastroAccessible = true;
                        closePasswordModal();
                        document.querySelector('.tab-button[data-tab="cadastro"]').classList.add('active');
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        document.getElementById('cadastro').classList.add('active');
                        renderMnemonicos();
                        renderResponsaveis();
                    } else {
                        input.classList.add('invalid');
                        confirmButton.classList.add('invalid');
                        modalContent.classList.add('shake');
                        setTimeout(() => {
                            modalContent.classList.remove('shake');
                        }, 500);
                    }
                }
                
                document.addEventListener('DOMContentLoaded', () => {
                    const passwordInput = document.getElementById('password-input');
                    if (passwordInput) {
                        passwordInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                checkPassword();
                            }
                        });
                    }
                });
                document.addEventListener('contextmenu', function(event) {
                    event.preventDefault();
                });
                function ctrlShiftKey(e, keyCode) {
                    return e.ctrlKey && e.shiftKey && e.keyCode === keyCode.charCodeAt(0);
                }

document.onkeydown = function(event) {
    if (
        event.keyCode === 123 ||  // F12
        ctrlShiftKey(event, 'I') ||  // Ctrl + Shift + I
        ctrlShiftKey(event, 'J') ||  // Ctrl + Shift + J
        ctrlShiftKey(event, 'C') ||  // Ctrl + Shift + C
        (event.ctrlKey && event.keyCode === 'U'.charCodeAt(0)) ||  // Ctrl + U
        (event.ctrlKey && event.keyCode === 'S'.charCodeAt(0))  // Ctrl + S
    ) {
        event.preventDefault();
        return false;
    }
};
                

function populateYearSelect() {
  const yearSelect = document.getElementById('yearSelect');
  const currentYear = new Date().getFullYear();
  yearSelect.innerHTML = '<option value="">Ano</option>';
  for (let year = currentYear; year >= currentYear - 2; year--) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    yearSelect.appendChild(option);
  }
}

function populateFormatSelect() {
  const formatSelect = document.getElementById('formatSelect');
  formatSelect.innerHTML = '<option value="">Tipo</option>';
  const options = [
    { value: 'excel', text: 'Excel' },
    { value: 'json', text: 'JSON' }
  ];
  options.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt.value;
    option.textContent = opt.text;
    formatSelect.appendChild(option);
  });
}

function enableDownloadButton() {
  const yearSelect = document.getElementById('yearSelect');
  const formatSelect = document.getElementById('formatSelect');
  const downloadBtn = document.getElementById('downloadBtn');
  if (yearSelect.value && formatSelect.value) {
    downloadBtn.classList.add('enabled');
  } else {
    downloadBtn.classList.remove('enabled');
  }
}

async function downloadBackup() {
  const year = document.getElementById('yearSelect').value;
  const format = document.getElementById('formatSelect').value;
  if (!year || !format) {
    alert('Por favor, selecione um ano e um formato.');
    return;
  }

  if (!selectedUnitId) {
    alert('Por favor, selecione uma unidade antes de baixar o backup.');
    return;
  }

  toggleLoadingScreen(true);
  try {
    const binId = getBinIdForUnit(selectedUnitId);
    const response = await fetch(`${JSONBIN_BASE_URL}/${binId}/latest`, {
      headers: {
        'X-Master-Key': JSONBIN_API_KEY
      }
    });

    if (!response.ok) {
      throw new Error('Erro ao carregar dados do JSONBin');
    }

    const result = await response.json();
    const data = result.record.dados || [];

    // Filtrar dados pelo ano selecionado
    const filteredData = data.filter(item => item.data.startsWith(year.toString()));

    if (format === 'excel') {
      // Mapear os dados para incluir nomes em vez de IDs para Excel
      const formattedData = filteredData.map(item => {
        const mnemonico = mnemonicos.find(m => m.id === item.mnemonicoId)?.mnemonico || 'Desconhecido';
        const responsavel = responsaveis.find(r => r.id === item.responsavelId)?.name || 'Desconhecido';
        return {
          Data: formatDateBR(item.data),
          Mnemonico: mnemonico,
          Responsável: responsavel,
          'Min Manhã ºC': item.manhaMin !== null ? item.manhaMin.toFixed(1) : '-',
          'Max Manhã ºC': item.manhaMax !== null ? item.manhaMax.toFixed(1) : '-',
          'Atual Manhã ºC': item.manhaAtual !== null ? item.manhaAtual.toFixed(1) : '-',
          'Min Tarde ºC': item.tardeMin !== null ? item.tardeMin.toFixed(1) : '-',
          'Max Tarde ºC': item.tardeMax !== null ? item.tardeMax.toFixed(1) : '-',
          'Atual Tarde ºC': item.tardeAtual !== null ? item.tardeAtual.toFixed(1) : '-',
          'Anotação': item.annotation || '-'
        };
      });

      // Criar planilha para Excel
      const worksheet = XLSX.utils.json_to_sheet(formattedData, {
        header: ['Data', 'Mnemonico', 'Responsável', 'Min Manhã ºC', 'Max Manhã ºC', 'Atual Manhã ºC', 'Min Tarde ºC', 'Max Tarde ºC', 'Atual Tarde ºC', 'Anotação'],
        skipHeader: false
      });

      // Ajustar largura das colunas
      const colWidths = [
        { wch: 12 }, // Data
        { wch: 15 }, // Mnemonico
        { wch: 20 }, // Responsável
        { wch: 12 }, // Min Manhã
        { wch: 12 }, // Max Manhã
        { wch: 12 }, // Atual Manhã
        { wch: 12 }, // Min Tarde
        { wch: 12 }, // Max Tarde
        { wch: 12 }, // Atual Tarde
        { wch: 30 }  // Anotação
      ];
      worksheet['!cols'] = colWidths;

      // Criar workbook
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, `Backup_${year}`);

      // Exportar para XLSX
      const selectedUnit = unidades.find(u => u.id === selectedUnitId);
      const unitName = selectedUnit ? selectedUnit.name.replace(/[^a-zA-Z0-9]/g, ' ') : 'Sem_Unidade';
      XLSX.writeFile(workbook, `Temperatura - ${unitName} - ${year}.xlsx`);
    } else if (format === 'json') {
      // Para JSON, usar estrutura original com IDs e data no formato americano (YYYY-MM-DD)
      const jsonData = filteredData.map(item => ({
        data: item.data,
        mnemonicoId: item.mnemonicoId,
        responsavelId: item.responsavelId,
        manhaMin: item.manhaMin,
        manhaMax: item.manhaMax,
        manhaAtual: item.manhaAtual,
        tardeMin: item.tardeMin,
        tardeMax: item.tardeMax,
        tardeAtual: item.tardeAtual,
        annotation: item.annotation
      }));

      // Criar JSON
      const jsonString = JSON.stringify(jsonData, null, 2);

      // Criar blob e download
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const selectedUnit = unidades.find(u => u.id === selectedUnitId);
      const unitName = selectedUnit ? selectedUnit.name.replace(/[^a-zA-Z0-9]/g, ' ') : 'Sem_Unidade';
      a.download = `Temperatura - ${unitName} - ${year}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  } catch (error) {
    console.error('Erro ao baixar backup:', error);
    alert('Erro ao baixar o backup do servidor.');
  } finally {
    toggleLoadingScreen(false);
  }
}

// Inicializar selects ao carregar a página
document.addEventListener('DOMContentLoaded', () => {
  populateYearSelect();
  populateFormatSelect();
  document.getElementById('yearSelect').addEventListener('change', enableDownloadButton);
  document.getElementById('formatSelect').addEventListener('change', enableDownloadButton);
  document.getElementById('downloadBtn').addEventListener('click', downloadBackup);
});


                document.getElementById('manha-min').addEventListener('input', validateForm);
                document.getElementById('manha-max').addEventListener('input', validateForm);
                document.getElementById('manha-atual').addEventListener('input', validateForm);
                document.getElementById('tarde-min').addEventListener('input', validateForm);
                document.getElementById('tarde-max').addEventListener('input', validateForm);
                document.getElementById('tarde-atual').addEventListener('input', validateForm);
                document.getElementById('dados-mnemonico').addEventListener('change', validateForm);
                document.getElementById('dados-responsavel').addEventListener('change', validateForm);
        </script>
</body>
</html>
